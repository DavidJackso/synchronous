name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  GO_VERSION: '1.24.4'
  DEPLOY_DIR: '/opt/synchronous'
  COMPOSE_FILE: 'docker-compose.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Deploy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "backend/,frontend/,docker-compose.yml"
          target: ${{ env.DEPLOY_DIR }}
          overwrite: true

      - name: Deploy and restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -euo pipefail
            
            cd ${{ env.DEPLOY_DIR }}
            
            # Update .env with secrets
            cat > .env << EOF
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            MAXAPI_BASE_URL=${{ secrets.MAXAPI_BASE_URL }}
            MAXAPI_ACCESS_TOKEN=${{ secrets.MAXAPI_ACCESS_TOKEN }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOF
            
            # Stop and remove old containers (only backend, frontend, swagger-ui)
            # Note: postgres and nginx are deployed manually and not managed here
            docker stop synchronous_frontend synchronous_backend synchronous_swagger_ui 2>/dev/null || true
            docker rm synchronous_frontend synchronous_backend synchronous_swagger_ui 2>/dev/null || true
            
            # Stop docker-compose services (only backend, frontend, swagger-ui)
            docker compose -f ${{ env.COMPOSE_FILE }} stop backend frontend swagger-ui 2>/dev/null || true
            docker compose -f ${{ env.COMPOSE_FILE }} rm -f backend frontend swagger-ui 2>/dev/null || true
            
            # Remove old images to force rebuild
            docker rmi synchronous-backend synchronous-frontend 2>/dev/null || true
            
            # Rebuild and start services (only backend, frontend, swagger-ui)
            docker compose -f ${{ env.COMPOSE_FILE }} build --no-cache backend frontend swagger-ui
            docker compose -f ${{ env.COMPOSE_FILE }} up -d backend frontend swagger-ui
            
            # Wait for services to start
            echo "Waiting for services to start..."
            sleep 15

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -euo pipefail
            
            cd ${{ env.DEPLOY_DIR }}
            
            echo "=== Container Status ==="
            docker compose -f ${{ env.COMPOSE_FILE }} ps
            
            echo -e "\n=== Backend Logs (last 50 lines) ==="
            docker compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 backend || true
            
            echo -e "\n=== Frontend Logs (last 50 lines) ==="
            docker compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 frontend || true
            
            echo -e "\n=== Health Checks ==="
            # Backend health check with retries
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:8080/api/v1/health > /dev/null; then
                echo "✅ Backend health check passed"
                break
              fi
              if [ $i -eq 5 ]; then
                echo "❌ Backend health check failed after 5 attempts"
                exit 1
              fi
              echo "⏳ Backend health check attempt $i/5 failed, retrying..."
              sleep 3
            done
            
            # Frontend health check with retries
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:3000/health > /dev/null; then
                echo "✅ Frontend health check passed"
                break
              fi
              if [ $i -eq 5 ]; then
                echo "❌ Frontend health check failed after 5 attempts"
                exit 1
              fi
              echo "⏳ Frontend health check attempt $i/5 failed, retrying..."
              sleep 3
            done
            
            echo -e "\n✅ All health checks passed!"